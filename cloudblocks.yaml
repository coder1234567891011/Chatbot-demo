name: chatbot-demo-app

blocks:
  vpc:
    type: aws::vpc
    properties:
      cidr: 10.0.0.0/16

  alb:
    type: aws::alb
    properties:
      vpc: $vpc
      subnets: public
      securityGroups:
        - allow: http # You can allow https here too
      listeners:
        - port: 80
          protocol: HTTP
          targetGroups:
            - name: chatbot-tg
              protocol: HTTP
              port: 80

  cluster:
    type: aws::ecs::cluster

  task:
    type: aws::ecs::taskDefinition
    properties:
      cpu: 256
      memory: 512
      containerDefinitions:
        - name: chatbot-container
          image: chatbot-demo:latest # Replace with real ECR URI
          portMappings:
            - containerPort: 8080
          environment:
            - name: NODE_ENV
              value: production
          secrets:
            - name: GPT_KEY
              valueFrom: "arn:aws:secretsmanager:us-east-1:897722706074:secret:GPT_KEY-8nu3KA"

  service:
    type: aws::ecs::service
    properties:
      cluster: $cluster
      taskDefinition: $task
      desiredCount: 1
      launchType: FARGATE
      networkConfiguration:
        subnets: public
        assignPublicIp: true
      loadBalancers:
        - targetGroup: $alb.listeners[0].targetGroups[0]
          containerName: main-container
          containerPort: 80
